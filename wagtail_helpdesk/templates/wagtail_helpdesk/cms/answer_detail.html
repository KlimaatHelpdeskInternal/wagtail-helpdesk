{% extends "wagtail_helpdesk/base.html" %}
{% load i18n static wagtailcore_tags wagtailimages_tags  %}
{% wagtail_site as current_site %}

{% block title %}
  {{ self.title }} | {{ current_site.site_name }}
{% endblock title %}

{% block extra_head %}
  {{ block.super }}

  {% with settings.cms.SocialMediaSettings as social_media_settings %}
    <link rel="canonical" href="{{ self.full_url }}">
    <meta property="og:title" content="{{ self.title }}">
    <meta property="twitter:title" content="{{ self.title }}">
    <meta property="og:type" content="article">
    {% if self.social_image %}
      {% image self.social_image width-400 as tmp_photo %}
      <meta property="og:image" content="{{ tmp_photo.url }}">
      <meta property="twitter:image" content="{{ tmp_photo.url }}">
    {% endif %}
    {% if self.excerpt %}
      <meta name="description" content="{{ self.excerpt }}">
      <meta name="og:description" content="{{ self.excerpt }}">
      <meta name="twitter:description" content="{{ self.excerpt }}">
    {% endif %}
    <meta property="twitter:site" content="@{{ social_media_settings.twitter_handle }}">
    <meta property="twitter:card" content="summary">
    {% with self.get_primary_expert as expert %}
      <meta name="author" content="{{ expert.name }}">
      <meta property="og:article:author" content="{{ expert.name }}">
      {% if expert.twitter_profile %}
        <meta property="twitter:creator" content="@{{ expert.twitter_username }}">
      {% endif %}
    {% endwith %}
    <!-- <meta name="keywords" content="{% for tag in self.tags.all %}{{ tag }}, {% endfor %}"> -->

    <meta property="og:locale" content="nl_NL">
    <meta property="og:site_name" content="{{ social_media_settings.short_site_name }}">
  {% endwith %}
{% endblock extra_head %}

{% block schema %}
  {{ block.super }}

  <script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Article",
  "headline": "{{ self.title }}",
  "datePublished": "{{ self.first_published_at|date:"c" }}",
  "dateModified": "{{ self.last_published_at|date:"c" }}",
  "abstract": "{% if self.excerpt %}
    {{ self.excerpt }}
  {% elif self.introduction %}
    {{ self.introduction }}
  {% endif %}",
  "author": { {% with self.get_primary_expert as expert %}
    "@type": "Person",
    "name": "{{ expert.name }}",
    "affiliation": "{{ expert.affiliation }}",
    "description": "{{ expert.bio }}",
    "url": "{{ expert.url }}"
  {% endwith %}},
  "url": "{{ self.full_url }}"
}
</script>
{% endblock schema %}

{% block description %}
  {% if self.excerpt %}
    {{ self.excerpt }}
  {% elif self.introduction %}
    {{ self.introduction }}
  {% endif %}
{% endblock %}

{% block navbar %}
  <div class="menu-bar menu-bar--inverted">
    <div class="menu-bar__bar">
      <div class="menu-bar__logo-container">
        {% block menu_bar_logo %}
        <a class="menu-bar__logo" href="/">
          {% include "wagtail_helpdesk/includes/logo.html" %}
        </a>
        {% endblock menu_bar_logo %}
      </div>

      <div class="menu-bar__expert-container">
        {% for expert in self.experts %}
          <a class="menu-bar__expert-link" href="/experts#{{ expert.pk }}">
            {% image expert.picture fill-200x200 as image %}
            <img class="menu-bar__image" src="{{ image.url }}" alt="{{ image.alt }}">
            <span class="menu-bar__expert-name">{{ expert.name }}</span>
            {% if self.experts|length == 1 %}
              <span class="menu-bar__expert-title">{{ expert.affiliation }}</span>
            {% endif %}
          </a>
        {% endfor %}
      </div>

      <div class="menu-bar__icon-container">
        <button class="menu-bar__icon-button" aria-label="{% trans 'Open menu' %}" data-action="navigation#open">
          <span class="menu-bar__icon"></span>
        </button>
      </div>
    </div>
  </div>
{% endblock %}


{% block head %}
  <div class="content-header" data-controller="video">
    <div class="content-header__wrapper">
      <a class="content-header__back-link" href="{% pageurl self.get_parent %}">
        <span class="content-header__back-link-icon"></span>
      </a>
      <div class="content-header__title-container">
        <h1 class="content-header__title">{{ self.title }}</h1>
      </div>

      <div class="content-header__theme">
        {% for category in self.get_all_categories %}
          <a href="{% pageurl self.get_parent %}{{ category.url }}">
            <span class="content-header__subject-tag tag">{{ category.title }}</span>
          </a>
        {% endfor %}
      </div>

      <div class="content-header__introduction" style="position:relative">
        {% if self.youtube_video_id %}
          <div class="video">

            <div class="video__video-abstract" role="region" aria-label="Introductie">
              <p class="content-header__introduction-text">{{ self.introduction }}</p>
            </div>

            <div style="height: 16px;"></div>

            <button
              id="toggleBtn"
              type="button"
              aria-controls="videoContent pageContent"
              aria-pressed="true"
              class="toggle-btn"
              style="padding:8px 16px;background:#f40a0a;color:#fff;border:none;border-radius:4px;cursor:pointer;"
            >
              Toon tekst
            </button>

            <div style="height: 16px;"></div>

            <div id="videoContent" class="video__video-content fade is-visible" role="region" aria-label="Videoweergave">
              <iframe width="342" height="609"
                      src="https://www.youtube.com/embed/{{ self.youtube_video_id }}"
                      title="{{ self.title }}" frameborder="0"
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                      referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
          </div>

          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const btn  = document.getElementById('toggleBtn');
              const vid  = document.getElementById('videoContent');
              const page = document.getElementById('pageContent');

              let isVideoVisible = true;

              function setState(showVideo) {
                isVideoVisible = showVideo;

                if (isVideoVisible) {
                  btn.textContent = 'Lees meer';
                  btn.setAttribute('aria-pressed', 'true');

                  vid.classList.remove('is-hidden');
                  vid.classList.add('is-visible');

                  if (page) {
                    page.classList.remove('is-visible');
                    page.classList.add('is-hidden');
                    page.setAttribute('aria-hidden', 'true');
                  }
                } else {
                  btn.textContent = 'Bekijk video';
                  btn.setAttribute('aria-pressed', 'false');

                  vid.classList.remove('is-visible');
                  vid.classList.add('is-hidden');

                  if (page) {
                    page.classList.remove('is-hidden');
                    page.classList.add('is-visible');
                    page.removeAttribute('aria-hidden');
                  }
                }
              }

              btn.addEventListener('click', function () {
                setState(!isVideoVisible);
              });

              setState(true);
            });
          </script>

        {% else %}
          <div class="video__video-abstract">
            <p class="content-header__introduction-text">{{ self.introduction }}</p>
          </div>
        {% endif %}
      </div>

      <!-- <div class="content-header__tags">
        {% for tag in self.tags.all %}
          <span class="content-header__tag">#{{ tag }}</span>
        {% endfor %}
      </div> -->
    </div>
  </div>
{% endblock %}


{# ==== HIERONDER: alles in 1 wrapper zodat het kan inklappen ==== #}
{% block content %}
  <!-- page_content is collapsed when video is visible -->
  <div id="pageContent" class="fade is-hidden">
    {% for block in self.page_content %}
      {% include_block block %}
    {% endfor %}
  </div>

  {% include "wagtail_helpdesk/includes/social_share_buttons.html" %}

  <!-- 4️⃣ Altijd zichtbaar -->
  {% for block in self.answer_origin %}
    {% include_block block %}
  {% endfor %}

  {% for block in self.related_items %}
    {% include_block block %}
  {% endfor %}
{% endblock %}
